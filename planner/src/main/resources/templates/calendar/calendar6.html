<!DOCTYPE html>
<html lang='ko'>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery -->
    <script src="/webjars/jquery/3.7.1/jquery.min.js"></script>

    <!-- jQuery UI -->
    <link rel="stylesheet" href="/webjars/jquery-ui/1.13.1/jquery-ui.css">
    <script src="/webjars/jquery-ui/1.13.1/jquery-ui.js"></script>

    <!-- flatpickr (미니 달력) -->
    <link rel="stylesheet" href="/webjars/flatpickr/4.6.13/dist/flatpickr.min.css">
    <script src="/webjars/flatpickr/4.6.13/dist/flatpickr.min.js"></script>
    <script src="/webjars/flatpickr/4.6.13/dist/l10n/ja.js"></script>

    <!-- fullcalendar (메인 달력) -->
    <script src='/webjars/fullcalendar/6.1.10/index.global.min.js'></script>

    <!-- bootstrap -->
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.2/css/bootstrap.min.css">
    <script src="/webjars/bootstrap/5.3.2/js/bootstrap.min.js"></script>

    <!-- moment -->
    <script src="/webjars/moment/2.30.1/min/moment.min.js"></script>

    <link href="/css/calendar/mini-calendar.css" rel="stylesheet">
    <link href="/css/calendar/plan.css" rel="stylesheet">

    <title>Calendar3</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            width: 1900px;
        }

        .calendar {
            display: flex;
            width: 100%;
            padding-top: 40px;
            justify-content: space-evenly;
        }

        #main-calendar {
            width: 50%;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var mainCalendar;
            var calendarEl = document.getElementById('main-calendar');
            mainCalendar = new FullCalendar.Calendar(calendarEl, {
                // 캘린더 설정
                headerToolbar: {
                    left: 'prevYear,prev,next,nextYear today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                initialView: 'dayGridMonth',
                contentHeight: 300,
                navLinks: true,
                selectable: true,
                editable: true,
                droppable: true,
                dayMaxEventRows: true,
                fixedWeekCount: false,
                locale: 'ko',

                eventClick: function (info) {
                    var eventId = info.event.id;
                    console.log(eventId);
                    selectDetail(eventId);
                },
                eventDrop: function (info) {
                    if (!confirm("일정을 이동하시겠습니까?")) {
                        info.revert();
                    } else {
                        updateEvent(info.event); // 일정 이동 시 변경된 정보로 업데이트 함수 호출
                    }
                },
                eventResize: function (info) {
                    if (!confirm("일정을 변경하시겠습니까?")) {
                        info.revert();
                    } else {
                        updateEvent(info.event); // 일정 변경 시 변경된 정보로 업데이트 함수 호출
                    }
                }
            });

            // 페이지 로드 시 일정 목록 조회
            selectList();

            // 캘린더 렌더링
            mainCalendar.render();

            // 일정 목록 조회 및 캘린더에 추가하는 함수
            function selectList() {
                $.ajax({
                    url: '/api/plan/selectList',
                    success: function(events) {
                        events.forEach(function(eventData) {
                            // eventData는 Plan 객체를 기반으로 한 JSON 형식이어야 합니다.
                            console.log('조회');
                            var event = {
                                id: eventData.id,
                                title: eventData.title,
                                start: eventData.startDate + 'T' + eventData.startTime, // 시작 일시
                                end: eventData.endDate + 'T' + eventData.endTime, // 종료 일시
                                allDay: eventData.allDay // 하루 종일 여부
                                // 추가적으로 필요한 속성이 있다면 여기에 추가할 수 있습니다
                            };
                            mainCalendar.addEvent(event);
                        });
                    },
                    error: function(xhr, status, error) {
                        alert('일정 목록 조회에 실패했습니다.');
                    }
                });
            }



            // 일정 상세 조회 함수
            function selectDetail(eventId) {
                $.ajax({
                    url: '/api/plan/selectDetail/' + eventId,
                    success: function(eventData) {
                        console.log(eventData);
                        fillEventForm(eventData);
                    },
                    error: function(xhr, status, error) {
                        alert('일정 상세 조회에 실패했습니다.');
                    }
                });
            }

            // 폼을 채우는 함수
            function fillEventForm(data) {
                $('#title').val(data.title);  // 제목
                $('#allDay').prop('checked', data.allDay);  // 하루종일 여부
                $('#startDate').val(data.startDate);  // 시작일
                $('#endDate').val(data.endDate);  // 종료일

                // 시간 선택 필드 (시작시간과 종료시간)는 별도의 처리가 필요할 수 있음
                // 예를 들어, '10:00'과 같은 형식의 데이터를 가정
                $('#startTime').val(data.startTime);
                $('#endTime').val(data.endTime);

                $('#place').val(data.place);  // 장소
                $('#repeat').val(data.repeat);  // 반복 설정
                $('#content').val(data.content);  // 설명
                $('#alarm').prop('checked', data.alarm);  // 알람 여부

                // 추가적인 필드 (예: id, userEmail)도 필요에 따라 채웁니다
                $('#id').val(data.id);
                $('#userEmail').val(data.userEmail);  // 사용자 이메일 필드가 있다면
            }

            // 저장 버튼 클릭 시
            document.getElementById('iuButton').addEventListener('click', function(event) {
                event.preventDefault();

                // HTML 폼의 값 가져오기
                var id = document.getElementById('id').value;
                var title = document.getElementById('title').value;
                var allDay = document.getElementById('allDay').checked;
                var startDate = document.getElementById('startDate').value;
                var startTime = document.getElementById('startTime').value;
                var endDate = document.getElementById('endDate').value;
                var endTime = document.getElementById('endTime').value;
                var place = document.getElementById('place').value;
                var content = document.getElementById('content').value;
                var repeat = document.getElementById('repeat').value;
                var alarm = document.getElementById('alarm').checked;

                // 이벤트 객체 생성
                var eventObj = {
                    id: id,
                    title: title,
                    allDay: allDay,
                    start: new Date(startDate),
                    end: new Date(endDate),
                    place: place,
                    content: content,
                    repeat: repeat,
                    alarm: alarm
                };

                if (id) {
                    // 일정 수정
                    $.ajax({
                        url: '/api/plan/update',
                        type: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(eventObj),
                        success: function(response) {
                            console.log('일정 수정 성공', response);
                            // 성공적으로 수정된 후의 처리 로직
                        },
                        error: function(xhr, status, error) {
                            console.error('일정 수정 실패', error);
                        }
                    });
                } else {
                    // 일정 추가
                    $.ajax({
                        url: '/api/plan/insert',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(eventObj),
                        success: function(response) {
                            console.log('일정 추가 성공', response);
                        },
                        error: function(xhr, status, error) {
                            console.error('일정 추가 실패', error);
                        }
                    });
                }



                // 이벤트 추가
                mainCalendar.addEvent(eventObj);

                // 이벤트 추가 후 폼 초기화
                document.getElementById('eventForm').reset();
            });

        });
    </script>


</head>

<body>
<div class="calendar">

    <!-- 메인 달력 -->
    <div id="main-calendar"></div>

    <!-- 일정 입력 폼 -->
    <div>
        <form id="eventForm">
            <table>
                <h3 id="eventTag">일정</h3>
                <tr>
                    <td colspan="2">
                        <input id="title" class="form-control" placeholder="제목 및 시간 추가" onfocus="this.placeholder=''"
                               onblur="this.placeholder='제목 및 시간 추가'" size="27px">
                    </td>
                </tr>
                <tr>
                    <td>
                        하루종일 <input type="checkbox" id="allDay" name="allDay" checked>
                    </td>
                </tr>
                <tr>
                    <td id="mini-calendar-input">
                        시작일 <input id="startDate" class="form-control">
                        종료일 <input id="endDate" class="form-control">
                    </td>
                </tr>
                <tr id="timeInputs">
                    <td>
                        시작시간 <select id="startTime" class="form-control"></select>
                        종료시간 <select id="endTime" class="form-control"></select>
                    </td>
                </tr>
                <tr>
                    <td>
                        장소 <input id="place" name="place" class="form-control">
                    </td>
                </tr>
                <tr>
                    <td>
                        <select id="repeat" class="form-select" aria-label="Default select example">
                            <option value="1">반복안함</option>
                            <option value="2">매일</option>
                            <option value="3">매주</option>
                            <option value="4">평일</option>
                            <option value="5">주말</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>
                          <textarea id="content" class="form-control" placeholder="설명 추가"
                                    onfocus="this.placeholder=''" onblur="this.placeholder='설명 추가'" cols="30" rows="4"></textarea>
                    </td>
                </tr>
                <tr>
                    <td>
                        알람 <input type="checkbox" id="alarm" name="alarm" checked>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <button id="iuButton" class="btn btn-primary">저장</button>
                        <button type="hidden" id="deletePlan" class="btn btn-primary">삭제</button>
                    </td>
                </tr>
            </table>
            <br>
            <input id="id" name="id">
            <input type="hidden" id="userEmail" name="userEmail">
        </form>
    </div>
</div>
<script src="/js/calendar/timeSettings.js"></script>
</body>
</html>